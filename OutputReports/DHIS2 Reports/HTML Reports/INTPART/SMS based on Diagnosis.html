<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
td {
	border: 1px solid black;
     padding: 1px;
    text-align: center;
	 
}
#table1 {
    table-layout: auto;
	border-collapse: collapse;
	 border:none;
}
.emptyRow td {
	border:none;
}
.less{
    margin:0;
    padding:0;
}
.emptyRow td {
	border:none;
}
textarea {    
    position: absolute;
    left: 30px;
}
</style>
</head>
<body>
Start Date:
  <input type="date" name="entry" id="start">
  End Date:
  <input type="date" name="exit" id="end">
 <button type="button"  id="myBtn" class="btn btn-info"  onclick="dm('dm');">DM</button>              
 <button type="button"  id="myBtn" class="btn btn-info"  style='margin-left:25px;'  onclick="dm('htn');">HTN</button>        
  <button type="button"  id="myBtn" class="btn btn-info"   style='margin-left:25px;' onclick="dm('copd');">COPD</button>   
    <button type="button"  id="myBtn" class="btn btn-info"  style='margin-left:25px;'  onclick="dm('cvd1');">CVD1</button>
 <button type="button"  id="myBtn" class="btn btn-info"  style='margin-left:25px;' onclick="dm('ca-other');">CA-Other</button> 
 <button type="button"  id="myBtn" class="btn btn-info"  style='margin-left:25px;' onclick="dm('rf');">RF</button>  
 <button type="button"  id="myBtn" class="btn btn-info"   style='margin-left:25px;' onclick="dm('ckd');">CKD</button>  
   <button type="button"  id="myBtn" class="btn btn-info"  style='margin-left:25px;'  onclick="dm('oral_ca');">Oral CA</button>  
   <button type="button"  id="myBtn" class="btn btn-info"  style='margin-left:25px;'  onclick="dm('cervical_ca');">Cervical CA</button>
    <button type="button"  id="myBtn" class="btn btn-info"  style='margin-left:25px;'  onclick="dm('breast_ca');">Breast CA</button>
</br>
</br>
<textarea id="test" rows="6" placeholder='Type the Sms content' cols="55">

</textarea>
</br>
</br>
</br>
</br>
</br>
</br>    

</br>
</br>
</br>
</br>
<a href="http://www.hindietools.com/2016/05/html-entity-to-unicode-unicode-to-html.html">CONVERT TO HTML ATTRIBUTE</a>
</br>
</br>
<table id="table1" class="report"   style="width:100%">
  
 
    </table>
	<script>
	
	</script>
	
   <script type="text/javascript" async>
   var smscontent;
   //var  mobileee=["8968999927","NA","9650597410","NA"];
     	 $.ajaxSetup({
        async: false
    });
	 var unicodeString = '';  
	    function dm(dmm){
		var show_case=dmm;
		//alert(dmabc);
	   var Table = document.getElementById("table1");
        Table.innerHTML = "";
	     var count=1;
	    var namee=[];
		var objid=[];
		var mobile=[];
		var adharnumber=[];
		var familyuniqueid=[];
		var objtrackinstance=[];
		var housenumber;
		var objhouse=[];
		var objcheck=[];
		var sex=[];
		var objtrack1=[];
		var objdiagnosis=[];
		var housedetailss=["xalnzkNfD77","nHR1zCU0maL","Dnm1mq6iq2d","PbEhJPnon0o","kelN057pfhq","zLsKdtlBCIx","Lt9ZrfgAMuw"];
		var objatt=[];
		var objattribute=[];
		var basichouse=["ZQMF7taSAw8","p6cLzDqCy0c","Q3FM5tnqXwm","caLxHmzEsxO","gfdru4cqZS0","LQi7veXJQ5D","gu2sb8mD9sR"];
		 var startdatee=document.getElementById('start').value;
				var enddatee=document.getElementById('end').value;
		   	 $.get("../api/events.json?orgUnit=lZtSBQjZCaX&program=jC8Gprj4pWV&startDate="+startdatee+"&endDate="+enddatee+"&skipPaging=true", function (data22) {
	
			var eventdata=data22;
                console.log(eventdata);
				for(var j=0;j<eventdata.events.length;j++)
				{
				
				
				   var dataval=eventdata.events[j].dataValues;
				   var trackinstanceid=eventdata.events[j].trackedEntityInstance
				   for(var q=0;q<dataval.length;q++)
				   {
				   var id=dataval[q].dataElement;
				  objid.push(id);
				   if(id=="FSD6mDILc7l")
				   {
				if(show_case=="htn"){
				   objcheck.push(id);
				 
				objdiagnosis.push("HTN");
					 }
				   }
				   else if(id=="C4YdSPG3Mr0"){  
				    if(show_case=="breast_ca"){
				   objcheck.push(id);
				  
				objdiagnosis.push("Breast CA");
				}
				   }
				   
				   else if(id=="gpJWjauP93y"){  
                        if(show_case=="cervical_ca"){				  
				  objcheck.push(id);		 
				objdiagnosis.push("Cervical CA");
				}
				   }
				   
				   else if(id=="ObkhLek0zZf"){
				   if(show_case=="oral_ca"){
				   objcheck.push(id);
				objdiagnosis.push("Oral CA");
				   }
				   }
				   
				   else if(id=="Fay65bFZIkC"){ 
				      if(show_case=="ckd"){
				   objcheck.push(id);
				
				objdiagnosis.push("CKD");
				}
				   }
				   
				   else if(id=="xFhzzBJ4Z6K"){  
				   if(show_case=="rf"){
				   objcheck.push(id);
				   
				objdiagnosis.push("RF");
				}
				   }
				   else if(id=="doZmhIPTR2O"){  
				   if(show_case=="copd"){
				   objcheck.push(id);
				   
				objdiagnosis.push("COPD");
				}
				   }
				    if(id=="GREEuTukX3P"){
					if(show_case=="dm"){
				   objcheck.push(id);
				 count++;
				objdiagnosis.push("DM");
				}
				   }
				   else if(id=="m63ulx9T3Ri"){   
				   if(show_case=="cvd1"){
				   objcheck.push(id);
				    
				objdiagnosis.push("CVD1");
				}
				   }
				   else if(id=="bv7PMXbyOZD"){  
				    if(show_case=="ca-other"){
				   objcheck.push(id);
				   
				objdiagnosis.push("CA-Other");
				}
				   }
				   }
				     if(objcheck.length>0){
				   objtrackinstance.push(trackinstanceid);
				   objcheck=[];
				   }
				   }
				   
				 console.log(objtrackinstance.length);
				 console.log("in loop"+count);
			  });
		 
	
		
		
		// getting family memeber according to diagnosis
		var smsbutton="<tr class='emptyRow' style='height:20px'><td></td><td></td><td></td><td></td><td></td><td><input type='button' id='btn' value='Send Sms'/></td></tr>";
		        
               var aadress="<tr style='border:1px solid black;background-color:orange;height:30px'><td>S.No</td><td> Name</td><td>Faimily_id</td><td>Sex</td><td>Mobile Number</td><td>Diagnosis</td></tr>";
		        
				  $(".report").append(smsbutton);
				 $(".report").append(aadress);
				 document.getElementById("btn").addEventListener("click", function() {
    sendsmss(mobile);
}, false);

		  for(x=0;x<objtrackinstance.length;x++)
		  {
	   var url1=  "../api/trackedEntityInstances/"+objtrackinstance[x]+".json?";
         $.get(url1, function (data1) {
			 
			var trackdata=data1;
               // console.log(trackdata);
					
				
				 for(var q=0;q<trackdata.attributes.length;q++)
                    {
					var idd =trackdata.attributes[q].attribute;
					// objatt.push(idd);	
					 objatt.push(idd);
				if(trackdata.attributes[q].attribute=="xalnzkNfD77")//name of family member
				{
				 
				var aa=trackdata.attributes[q].value;
				 namee.push(aa);
				
				}
				if(trackdata.attributes[q].attribute=="PbEhJPnon0o")//sex
				{
				
				var aa=trackdata.attributes[q].value;
				sex.push(aa);
				
				}
				if(trackdata.attributes[q].attribute=="Lt9ZrfgAMuw")//mobile number
				{
				
				var aa=trackdata.attributes[q].value;
				mobile.push(aa);
				
				}
				if(trackdata.attributes[q].attribute=="Dnm1mq6iq2d")//family unique id
				{
				
				var aa=trackdata.attributes[q].value;
				familyuniqueid.push(aa);
				
				}
				 }
				  var array3 = housedetailss.filter(function(obj) { return objatt.indexOf(obj) == -1; });
		          for(var t=0;t<array3.length;t++)
					{
					if(array3[t]=="xalnzkNfD77") 
				      namee.push("NA");
					else if(array3[t]=="Dnm1mq6iq2d")
					familyuniqueid.push("NA");
					else if(array3[t]=="PbEhJPnon0o")
					sex.push("NA");
					else if(array3[t]=="Lt9ZrfgAMuw")  
					mobile.push("NA");
					
					
					}
					
				 		objatt=[];
				   
				 
				 		//objatt=[];
				   
				  });
				   var result="<tr style='border:1px solid black;background-color:white;'><td>"+x+"</td><td>"+namee[x]+"</td><td>"+familyuniqueid[x]+"</td><td>"+sex[x]+"</td><td>"+mobile[x]+"</td><td>"+objdiagnosis[x]+"</td></tr>";
		        
				 
				 $(".report").append(result);
				  }
				
	
				
			
			}
			 
	function sendsmss(mobile){

	 smscontent= document.getElementById('test').value;
 var finalcontent = encodeURIComponent(smscontent);

var smsurl = "http://msdgweb.mgov.gov.in/esms/sendsmsrequest?username=PHD25PGIMER&password=sph@25&smsservicetype=unicodemsg&content="+finalcontent+"&mobileno="+mobile+"&senderid=PGIMER";
 // var smsurl = "http://msdgweb.mgov.gov.in/esms/sendsmsrequest?username=PHD25PGIMER&password=sph@25&smsservicetype=unicodemsg&content=hyy&mobileno=8968999927&senderid=PGIMER";         
		   httpGet(smsurl);

	}
	
	

	
	function httpGet(theUrl)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "POST", theUrl, false );
    xmlHttp.send( null );
    return xmlHttp.responseText;
}

	
/*
	  httpGet = function (theUrl) {
        $.ajax({
                type: 'post',
                encoding: "UTF-8",
                dataType: "html",
                 contentType: 'application/x-www-form-urlencoded',
                url: theUrl,
                success: function (msg) {
                    //alert(msg);
                }

        })
	
     }

*/
	
   </script>
  

  </body>
  </html>